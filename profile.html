<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediTrack for Kids: Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Open+Sans&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f0f4f8, #ffffff);
      font-family: 'Open Sans', sans-serif;
      color: #343A40;
      min-height: 100vh;
    }
    .navbar {
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem 0;
    }
    .nav-links {
      list-style-type: none;
      display: flex;
      gap: 25px;
      margin: 0;
      padding: 0;
    }
    .nav-links a {
      color: #343A40;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease, transform 0.2s ease;
    }
    .nav-links a:hover {
      color: #DC3545;
      transform: scale(1.05);
    }
    .navbar-brand {
      color: #DC3545;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1.5rem;
      margin-left: auto;
    }
    .header {
      font-family: 'Poppins', sans-serif;
      color: #DC3545;
      margin-bottom: 1.5rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }
    .medi-card {
      border: 2px solid #E9ECEF;
      border-radius: 10px;
      background: #ffffff;
      transition: all 0.4s ease;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .medi-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    .medi-btn {
      background-color: #DC3545;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-size: 1rem;
      padding: 8px 15px;
      color: #fff;
    }
    .medi-btn:hover {
      background-color: #C82333;
      transform: scale(1.05);
    }
    .progress-bar {
      background: #E9ECEF;
      border-radius: 8px;
      overflow: hidden;
      height: 20px;
      margin-top: 15px;
    }
    .progress-fill {
      background: #DC3545;
      height: 100%;
      transition: width 0.5s ease;
      border-radius: 8px;
    }
    .reward-popup {
      border: 2px solid #FFC107;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      transition: opacity 0.4s ease;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      padding: 25px;
      text-align: center;
    }
    #wallet-address {
      margin-top: 15px;
      font-size: 1rem;
      color: #28a745;
      font-weight: 600;
    }
    #profile-select {
      margin-top: 15px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #E9ECEF;
      transition: border-color 0.3s ease;
    }
    #profile-select:focus {
      border-color: #DC3545;
      outline: none;
    }
    .reset-btn {
      margin-top: 15px;
      background-color: #6c757d;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .reset-btn:hover {
      background-color: #5a6268;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="profile.html">Profiles</a></li>
        <li><a href="logs.html">Logs</a></li>
        <li><a href="rewards.html">Rewards</a></li>
      </ul>
      <a class="navbar-brand" href="#">MediTrack</a>
    </div>
  </nav>
  <div class="container py-5 text-center">
    <h1 class="header">Child Profile</h1>
    <p class="text-muted mb-4">Track your kid's medication with ease!</p>
    <div class="mt-4">
      <select id="profile-select" onchange="loadProfile()">
        <option value="0">Child 1</option>
        <option value="1">Child 2</option>
      </select>
      <div class="card medi-card mx-auto" style="width: 60%; height: 300px;" id="profile-card">
        <h2 class="card-title fs-5 text-center header" id="child-name">Child 1</h2>
        <p class="card-text text-center text-muted" id="child-details">Age: 8 | Med: Amoxicillin</p>
        <div class="d-flex justify-content-around mt-3">
          <button class="btn medi-btn text-white" onclick="logDose(this)">Morning ðŸ’Š</button>
          <button class="btn medi-btn text-white" onclick="logDose(this)">Afternoon ðŸ’Š</button>
          <button class="btn medi-btn text-white" onclick="logDose(this)">Night ðŸ’Š</button>
        </div>
        <div class="progress-bar mt-3">
          <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
        </div>
      </div>
      <button class="btn btn-outline-dark mt-3" onclick="connectMetaMask()">Connect Wallet</button>
      <div id="wallet-address"></div>
      <button class="btn reset-btn mt-3" onclick="resetAll()">Reset All</button>
    </div>
    <div id="reward-popup" class="d-none position-fixed top-50 start-50 translate-middle p-4 reward-popup">
      <h2 class="header fs-4 text-center">Medication Course Completed!</h2>
      <p class="text-center text-muted">10 Kaia Tokens Awarded ðŸŽ‰</p>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script>
    // Initialize Web3
    let web3;
    if (window.ethereum) {
      web3 = new Web3(window.ethereum);
    } else {
      console.error("Web3 not detected. Please install MetaMask!");
    }

    // Profile Data (stored in localStorage)
    let profiles = JSON.parse(localStorage.getItem('mediTrackProfiles')) || [
      { name: "Child 1", age: 8, med: "Amoxicillin", progress: 0 },
      { name: "Child 2", age: 10, med: "Paracetamol", progress: 0 }
    ];
    localStorage.setItem('mediTrackProfiles', JSON.stringify(profiles));
    console.log("Profile data set:", profiles); // Debug log

    let currentProfileIndex = 0;

    // Debug GSAP load
    console.log("GSAP Loaded:", typeof gsap !== 'undefined' ? "Yes" : "No");

    // GSAP Animations
    gsap.from(".medi-card", { duration: 0.6, opacity: 0, y: 30, ease: "power2.out" });
    gsap.from(".header", { duration: 0.6, opacity: 0, y: -30, ease: "power2.out", delay: 0.2 });
    gsap.from(".nav-links a", { duration: 0.5, opacity: 0, stagger: 0.1, ease: "power1.out" });

    // Reward Popup Animation
    function showRewardPopup() {
      const popup = document.getElementById("reward-popup");
      if (typeof gsap !== 'undefined') {
        gsap.fromTo(popup, { opacity: 0, scale: 0.9 }, { opacity: 1, scale: 1, duration: 0.4, ease: "back.out(1.7)" });
        popup.style.display = "block";
        setTimeout(() => {
          gsap.to(popup, { opacity: 0, scale: 0.9, duration: 0.4, ease: "power1.in", onComplete: () => popup.style.display = "none" });
        }, 3500);
      } else {
        console.error("GSAP not loaded!");
        popup.style.display = "block";
        setTimeout(() => popup.style.display = "none", 3500);
      }
    }

    // Load Profile
    function loadProfile() {
      currentProfileIndex = parseInt(document.getElementById("profile-select").value);
      const profile = profiles[currentProfileIndex];
      document.getElementById("child-name").textContent = profile.name;
      document.getElementById("child-details").textContent = `Age: ${profile.age} | Med: ${profile.med}`;
      document.getElementById("progress-fill").style.width = `${profile.progress}%`;
      console.log(`Loaded profile: ${profile.name}, Progress: ${profile.progress}%`);
    }

    // Dose Logging
    function logDose(button) {
      const profile = profiles[currentProfileIndex];
      const doseTime = button.textContent.trim();
      profile.progress = Math.min((profile.progress + 33.33), 100);
      console.log(`Dose logged: ${doseTime}, New Progress: ${profile.progress}%`);
      gsap.to("#progress-fill", { width: `${profile.progress}%`, duration: 0.5, ease: "power1.out" });

      localStorage.setItem('mediTrackProfiles', JSON.stringify(profiles));

      let logs = JSON.parse(localStorage.getItem('mediTrackLogs')) || [];
      logs.push({ child: profile.name, time: Date.now(), dose: doseTime });
      localStorage.setItem('mediTrackLogs', JSON.stringify(logs));
      console.log("Updated logs in localStorage:", logs); // Debug log

      if (profile.progress >= 99.9) {
        connectAndReward();
        console.log("Reached 100%, calling connectAndReward");
        profile.progress = 0; // Reset for next cycle
        localStorage.setItem('mediTrackProfiles', JSON.stringify(profiles));
      }
    }

    // MetaMask Connection
    async function connectMetaMask() {
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        const walletAddress = accounts[0];
        document.getElementById('wallet-address').innerText = `Connected: ${walletAddress.substring(0, 6)}...${walletAddress.slice(-4)}`;
        console.log("Connected Address:", walletAddress);
        alert("Connected to MetaMask!");
      } catch (error) {
        console.error("Connection failed:", error);
        alert("Connection failedâ€”check console.");
      }
    }

    // MetaMask & Token Reward
    const CONTRACT_ADDRESS = '0x7f162Bff45f68caf03595F28470AD44348984B2d';
    const ABI = [
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true, "internalType": "address", "name": "from", "type": "address"},
          {"indexed": true, "internalType": "address", "name": "to", "type": "address"},
          {"indexed": false, "internalType": "uint256", "name": "value", "type": "uint256"}
        ],
        "name": "Transfer",
        "type": "event"
      },
      {
        "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [{"internalType": "address", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "recipient", "type": "address"},
          {"internalType": "uint256", "name": "amount", "type": "uint256"}
        ],
        "name": "transfer",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    async function connectAndReward() {
      if (window.ethereum && web3) {
        try {
          const accounts = await web3.eth.getAccounts();
          const userAddress = accounts[0];
          const contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);

          const owner = await contract.methods.owner().call();
          console.log("Contract Owner:", owner);

          const tx = await contract.methods.transfer(userAddress, 10).send({ from: '0xe72f8652abf774313416a210c3a59988926cD7d0', gas: 500000 });
          console.log("Transfer successful, TX Hash:", tx.transactionHash);
          showRewardPopup();
        } catch (error) {
          console.error("Error during transfer:", error);
          alert("Reward failedâ€”check console. Error: " + error.message);
        }
      } else {
        alert("Please install MetaMask!");
      }
    }

    // Reset All Data
    function resetAll() {
      if (confirm("Are you sure you want to reset all data?")) {
        localStorage.removeItem('mediTrackProfiles');
        localStorage.removeItem('mediTrackLogs');
        profiles = [
          { name: "Child 1", age: 8, med: "Amoxicillin", progress: 0 },
          { name: "Child 2", age: 10, med: "Paracetamol", progress: 0 }
        ];
        localStorage.setItem('mediTrackProfiles', JSON.stringify(profiles));
        document.getElementById("progress-fill").style.width = "0%";
        loadProfile();
        alert("Data reset successfully!");
        console.log("All data reset");
      }
    }

    // Initial load
    loadProfile();
  </script>
</body>
</html>